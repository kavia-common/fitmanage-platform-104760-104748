# Fitness & Nutrition Backend API and Setup Guide

## Introduction

### Background
This document describes the backend API surface of the Fitness & Nutrition platform, summarizes the domain modules, and explains how to generate and consume the OpenAPI schema. It also details all configuration and environment variables and the steps to run the backend for local development.

### Scope
The scope includes:
- API overview and domain modules enabled in the current codebase
- How OpenAPI is generated and where the schema is stored
- Security and authentication model
- Configuration and environment variables
- Local setup instructions and developer workflow

## API Overview

### Architecture
The backend is implemented with FastAPI and organized in domain-specific routers mounted under the /api prefix. The central application factory is defined in src/api/main.py and includes:
- CORS middleware setup
- Health checks at / and /api/
- OpenAPI documentation configuration including tags and summaries
- Inclusion of all domain routers via src/api/router.py

### Domains and Tags
The following domain modules and OpenAPI tags are currently exposed (configured in src/api/main.py and src/api/router.py):
- health: Service health and diagnostics
- auth: Authentication endpoints (register, login)
- users: Users management (requires authentication)
- workouts: Workout plans and logs
- diet: Diet plans and entries
- clients: Client management for professionals
- protocols: Protocol goals and progress tracking
- notifications: Notifications and alerts
- subscriptions: Subscription plans and billing
- reports: Reporting and analytics
- settings: User preferences
- websocket: WebSocket real-time connections and usage help

### Authentication and Security
- JWT-based authentication is used for protected routes.
- Obtain a token via POST /api/auth/login and provide the token to the Swagger “Authorize” button or via Authorization: Bearer <token>.
- The OpenAPI security scheme is defined as OAuth2 Password flow with tokenUrl /api/auth/login.
- Role checks (admin, professional) are enforced in several routes.

### WebSocket
A WebSocket endpoint is available at /api/notifications/ws and expects a token query parameter containing a valid JWT. See GET /api/ws-help for inline usage help.

## OpenAPI Schema

### How OpenAPI is generated
The OpenAPI JSON is generated by running src/api/generate_openapi.py, which imports the FastAPI app from src/api/main.py and serializes app.openapi() to a file:
- Output directory: interfaces
- Output file: interfaces/openapi.json

File: src/api/generate_openapi.py
- Creates the app via import of src/api/main.app
- Dumps the OpenAPI schema as JSON with indentation for readability

### Where to find the schema
- The generated schema is committed at: interfaces/openapi.json
- When the backend is running, the live schema is available at /openapi.json and the Swagger UI at /docs

### Keeping tags, summaries, and responses accurate
The codebase already annotates endpoints with:
- summary and description in route decorators
- response_model for structured responses
- explicit status codes for creation/deletion endpoints
These annotations are the source of truth for generated OpenAPI. When adding new endpoints, ensure summary, description, tags, status_code (when applicable), and response_model are provided.

## Endpoints Summary

### Health
- GET /: Health Check
- GET /api/: API Health

### Authentication
- POST /api/auth/login: Authenticate and get JWT (response: Token)
- POST /api/auth/register: Register new user (response: UserRead)

### Users
- GET /api/users/: List users (admin/pro)
- GET /api/users/me: Current user
- GET /api/users/{user_id}: Get user by ID (admin/pro)
- POST /api/users/: Create user (admin/pro) (response: UserRead, 201)
- PUT /api/users/{user_id}: Update user (self or admin/pro)
- DELETE /api/users/{user_id}: Delete user (admin/pro) (204)

### Workouts
- GET /api/workouts/: List workouts with pagination
- POST /api/workouts/: Create workout (201)
- GET /api/workouts/{plan_id}: Get workout by ID
- PUT /api/workouts/{plan_id}: Update workout
- DELETE /api/workouts/{plan_id}: Delete workout (204)

### Diet
- GET /api/diet/: List diet plans with pagination
- POST /api/diet/: Create diet plan (201)
- GET /api/diet/{plan_id}: Get diet plan
- PUT /api/diet/{plan_id}: Update diet plan
- DELETE /api/diet/{plan_id}: Delete diet plan (204)

### Clients
- GET /api/clients/: List clients with pagination
- POST /api/clients/: Create client (201)
- GET /api/clients/{client_id}: Get client
- PUT /api/clients/{client_id}: Update client
- DELETE /api/clients/{client_id}: Delete client (204)

### Protocols and Progress
- GET /api/protocols/: List protocol goals
- POST /api/protocols/: Create protocol goal (201)
- GET /api/protocols/{goal_id}: Get protocol goal
- PUT /api/protocols/{goal_id}: Update protocol goal
- DELETE /api/protocols/{goal_id}: Delete protocol goal (204)
- GET /api/protocols/{goal_id}/progress: List progress for a goal
- POST /api/protocols/{goal_id}/progress: Create progress point (201)
- DELETE /api/protocols/{goal_id}/progress/{progress_id}: Delete progress point (204)

### Notifications
- GET /api/notifications/: List notifications with pagination and optional is_read filter
- POST /api/notifications/: Create notification
- POST /api/notifications/{notification_id}/read: Mark as read
- DELETE /api/notifications/{notification_id}: Delete notification
- WS /api/notifications/ws: Real-time notifications (connect with ?token=<JWT>)

### Subscriptions
- GET /api/subscriptions/: List subscriptions
- POST /api/subscriptions/checkout: Create checkout session (stub)
- POST /api/subscriptions/activate: Activate subscription (stub) (201)
- POST /api/subscriptions/cancel: Cancel subscription (stub)

### Reports
- GET /api/reports/: List reports
- GET /api/reports/summary: Summary report
- GET /api/reports/trends?days=N: Activity trends
- GET /api/reports/clients-breakdown: Per-client plan breakdown

### Settings
- GET /api/settings/me: Read user preferences
- PUT /api/settings/me: Update user preferences

## Configuration and Environment Variables

### Source of configuration
Configuration is defined in src/core/config.py using Pydantic BaseSettings. By default, environment variables are loaded from a .env file in the project root (env_file=".env", case_sensitive=True).

### Variables
- APP_NAME: Application visible name (default: "Fitness & Nutrition API")
- APP_DESCRIPTION: Description shown in docs (default: "REST API for fitness and nutrition management with modular domains.")
- APP_VERSION: Semantic version string (default: "0.1.0")
- ENV: Environment name ("development" by default)

CORS
- BACKEND_CORS_ORIGINS: List of allowed origins for CORS. Defaults to ["http://localhost","http://localhost:3000","http://localhost:5173"]. Provide as a JSON array or comma-separated string supported by pydantic-settings.

Security / JWT
- SECRET_KEY: Secret key used for token signing. Must be provided securely in non-development environments.
- ACCESS_TOKEN_EXPIRE_MINUTES: JWT expiry in minutes (default 1440).
- ALGORITHM: JWT algorithm (default HS256).
- JWT_ISSUER: Optional issuer (iss) claim.
- JWT_AUDIENCE: Optional audience (aud) claim.

Database
- DATABASE_URL: SQLAlchemy URL (default sqlite:///./app.db). Examples:
  - SQLite: sqlite:///./app.db
  - Postgres: postgresql+psycopg2://user:pass@host:5432/dbname
- SQL_ECHO: Enable SQLAlchemy echo logging (default False).

WebSockets
- WEBSOCKET_BASE_PATH: Base path for ws endpoints (default /ws; current implementation uses explicit path /api/notifications/ws).

### .env example
Create a .env file in fitness_nutrition_backend with values similar to:
APP_NAME="Fitness & Nutrition API"
APP_DESCRIPTION="REST API for fitness and nutrition management with modular domains."
APP_VERSION="0.1.0"
ENV=development
DATABASE_URL=sqlite:///./app.db
SQL_ECHO=false
SECRET_KEY="please-change-this-in-production"
ACCESS_TOKEN_EXPIRE_MINUTES=1440
ALGORITHM=HS256
BACKEND_CORS_ORIGINS=["http://localhost","http://localhost:3000","http://localhost:5173"]
WEBSOCKET_BASE_PATH=/ws

## Local Setup

### Prerequisites
- Python 3.11+
- Virtual environment tool (e.g., venv)
- Optional: PostgreSQL if using a Postgres DATABASE_URL

### Installation
- cd fitness_nutrition_backend
- python -m venv .venv
- source .venv/bin/activate (Linux/macOS) or .venv\Scripts\activate (Windows)
- pip install --upgrade pip
- pip install -r requirements.txt
- Create .env as per the section above

### Database
For local development, SQLite is supported out of the box. Tables are created on first start via Base.metadata.create_all(bind=engine) in src/api/main.py.

Alembic migrations (optional for development; recommended for production) are provided:
- Initialize first migration:
  - alembic revision --autogenerate -m "init"
  - alembic upgrade head
Refer to SETUP_DB.md for additional details.

### Running the server
- uvicorn src.api.main:app --reload --host 0.0.0.0 --port 8000
- Swagger UI: http://localhost:8000/docs
- OpenAPI JSON: http://localhost:8000/openapi.json
- Health checks: GET / and GET /api/

### Generating OpenAPI schema file
To regenerate the static OpenAPI schema JSON used by the repository:
- Ensure the virtual environment is activated and dependencies installed.
- From project root (fitness_nutrition_backend), run:
  - python -m src.api.generate_openapi
- The schema will be written to interfaces/openapi.json.
Note: This script imports the application, so environment variables will be loaded from .env.

## Developer Notes

### Adding endpoints
- Always include clear summary and description in the route decorator.
- Set response_model with a Pydantic schema where applicable.
- Add appropriate status_code (e.g., 201 for creation, 204 for delete).
- Use tags consistent with existing domains, or extend openapi_tags in src/api/main.py when introducing a new domain.

### Pagination
Common utilities are provided in src/api/utils.py (pagination_params and paginate). Use these dependencies for list endpoints to standardize pagination semantics and documentation.

## Conclusion

### Summary
The backend exposes a comprehensive REST API organized by domain with proper OpenAPI documentation generated via src/api/generate_openapi.py. Authentication is JWT-based with role-aware access control. Configuration is driven by environment variables loaded from .env. Follow the setup steps and generation commands to run and document the backend consistently.
